{"remainingRequest":"/Users/dmsun/Desktop/workspace/solar/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/dmsun/Desktop/workspace/solar/src/pages/welfare/views/Goods.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/dmsun/Desktop/workspace/solar/src/pages/welfare/views/Goods.vue","mtime":1547889925000},{"path":"/Users/dmsun/Desktop/workspace/solar/node_modules/cache-loader/dist/cjs.js","mtime":1547890140000},{"path":"/Users/dmsun/Desktop/workspace/solar/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/dmsun/Desktop/workspace/solar/node_modules/cache-loader/dist/cjs.js","mtime":1547890140000},{"path":"/Users/dmsun/Desktop/workspace/solar/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\n// @ is an alias to /src\nimport UploadImage from '../components/UploadImage'\nimport Comfirm from '@/components/Comfirm'\nimport qs from 'qs'\nexport default {\n  components: {\n    UploadImage,\n    Comfirm\n  },\n  data () {\n    return {\n      headers: [\n        { text: '商品ID', value: 'id', sortable: false },\n        { text: '商品名称', value: 'name', sortable: false },\n        { text: '原价', value: 'original', sortable: false },\n        { text: '现价', value: 'current', sortable: false },\n        { text: '库存', value: 'total', sortable: false },\n        { text: '商户', value: 'id', sortable: false },\n        { text: '地区', value: 'address', sortable: false },\n        { text: '状态', value: 'status', sortable: false },\n        { text: '详情', value: 'id', sortable: false }\n      ],\n      isPending: false,\n      desserts: [],\n      total: 0,\n      page: 1,\n      pageSize: 10,\n      currentItem: {}, // 当前操作 table item\n      showComfirm: false,\n      selectItems: [{\n        value: 10,\n        text: '10条/页'\n      }, {\n        value: 20,\n        text: '20条/页'\n      }, {\n        value: 50,\n        text: '50条/页'\n      }],\n      isShowDialog: false, // 新增弹框\n      isReadOnly: false,\n      isUpdate: false,\n      valid: false,\n      startDatemenu: false,\n      endDatemenu: false,\n      startTimeMenu: false,\n      endTimeMenu: false,\n      goodsInfo: {\n        name: '',\n        images: [],\n        intro: '',\n        details: [],\n        notice: '',\n        start_date: '',\n        end_date: '',\n        startTime: null,\n        endTime: null,\n        exchange: [],\n        userid: ''\n      },\n      stores: [], // 适用门店\n      formRulse: {\n        nameRules: [\n          v => !!v || '商品名称不能为空',\n          v => (v && v.length <= 100) || '100字以内'\n        ],\n        introRules: [\n          v => (v && v.length <= 1000) || '1000字以内'\n        ],\n        originalRules: [\n          v => !!v || '原价不能为空',\n          v => /^\\d+(\\.\\d{1,2})?$/.test(v) || '原价格式不正确'\n        ],\n        currentRules: [\n          v => !!v || '现价不能为空',\n          v => /^\\d+(\\.\\d{1,2})?$/.test(v) || '现价格式不正确'\n        ],\n        totalRules: [\n          v => !!v || '库存不能为空',\n          v => /^[1-9]\\d*$/.test(v) || '库存必须为数值'\n        ],\n        dateRules: [\n          v => !!v || '有效期不能为空'\n        ],\n        useridRules: [\n          v => !!v || '关联商户id不能为空'\n        ],\n        srcRules: [\n          v => (!v || v.length <= 10) || '10字以内'\n        ],\n        storesRules: [\n          v => (Array.isArray(v) && v.length > 0) || '兑换门店不能为空'\n        ],\n        noticeRules: [\n          v => (v && v.length <= 400) || '400字以内'\n        ]\n      },\n      currencyErrorMessages: '',\n      useridErrorMessages: ''\n    }\n  },\n  computed: {\n    current_format: {\n      get: function () {\n        return this.goodsInfo.current / 100 || ''\n      },\n      set: function (value) {\n        this.goodsInfo.current = value * 100 || ''\n      }\n    },\n    original_format: {\n      get: function () {\n        return this.goodsInfo.original / 100 || ''\n      },\n      set: function (value) {\n        this.goodsInfo.original = value * 100 || ''\n      }\n    }\n  },\n  created () {\n    this.fetchData()\n  },\n  methods: {\n    verifyCurrency() {\n      if (!this.goodsInfo.current || !this.goodsInfo.original) {\n        return\n      }\n      if (this.goodsInfo.original < this.goodsInfo.current) {\n        this.currencyErrorMessages = '原价不能小于现价'\n      } else {\n        this.currencyErrorMessages = ''\n      }\n    },\n    fetchData () {\n      this.isPending = true\n      this.$http({\n        url: '/travel/goods/info',\n        method: 'GET',\n        params: {\n          type: 1,\n          pageSize: this.pageSize,\n          page: this.page - 1 // 接口 第一页 page = 0\n        }\n      }).then(response => {\n        this.isPending = false\n        let res = response.data\n        if (res.respcd === '0000') {\n          this.desserts = res.data.list\n          this.total = res.data.total\n        } else {\n          this.$store.dispatch('setAlert', {\n            alert: true,\n            alertContent: res.respmsg,\n            alertType: 'error'\n          })\n        }\n      })\n    },\n    fetchStores (id, resetSelected) {\n      if (resetSelected && Number(id) === this.goodsInfo.userid) {\n        return\n      }\n      this.$http({\n        url: '/travel/goods/options',\n        method: 'POST',\n        data: qs.stringify({\n          id,\n          mode: 'shop_info'\n        })\n      }).then(response => {\n        let res = response.data\n        if (res.respcd === '0000') {\n          this.useridErrorMessages = ''\n          if (resetSelected) {\n            this.stores = []\n            this.goodsInfo.exchange = []\n          }\n          res.data.map((item) => {\n            this.stores.push({\n              id: item.id,\n              name: item.name\n            })\n          })\n        } else if (res.respcd === '2102') {\n          this.useridErrorMessages = '该商户不存在，请检查商户id是否正确'\n        } else if (res.respcd === '2101') {\n          this.useridErrorMessages = '该商户下没有门店，请先添加门店'\n        }\n      })\n    },\n    addButton () {\n      this.reset()\n      this.isReadOnly = false\n      this.isShowDialog = true\n      this.isUpdate = false\n    },\n    goGoodsDetail (id, name) {\n      window.sessionStorage.setItem('goodsName', name)\n      this.$router.push({\n        name: 'store',\n        params: {\n          goodsId: id\n        }\n      })\n    },\n    viewGoods (info) {\n      this.isReadOnly = true\n      this.isShowDialog = true\n      this.isUpdate = true\n      this.goodsInfo = { ...info }\n      this.goodsInfo.start_date = info.start_date.substr(0, 10)\n      this.goodsInfo.end_date = info.end_date.substr(0, 10)\n      if (info.cut_expire) {\n        this.goodsInfo.startTime = info.cut_expire[0].start_time\n        this.goodsInfo.endTime = info.cut_expire[0].end_time\n      }\n      delete this.goodsInfo['cut_expire']\n      this.$refs.uploadimage.previewImages = [...info.images]\n      this.$refs.uploadetail.previewImages = [...info.details]\n      this.fetchStores(info.userid, false)\n    },\n    submit () {\n      if (!this.$refs.form.validate()) {\n        return\n      }\n      let images = this.$refs.uploadimage.previewImages\n      let details = this.$refs.uploadetail.previewImages\n      if (images.length === 0) {\n        this.$store.dispatch('setAlert', {\n          alert: true,\n          alertContent: '请上传商品图片',\n          alertType: 'warning'\n        })\n        return false\n      }\n      if (details.length === 0) {\n        this.$store.dispatch('setAlert', {\n          alert: true,\n          alertContent: '请上传商品详情图',\n          alertType: 'warning'\n        })\n        return false\n      }\n      let startTime = this.goodsInfo.startTime\n      let endTime = this.goodsInfo.endTime\n      if ((!!startTime && !endTime) || (!startTime && !!endTime)) {\n        this.$store.dispatch('setAlert', {\n          alert: true,\n          alertContent: '请填写完整使用时间段',\n          alertType: 'warning'\n        })\n        return false\n      }\n      let params = { ...this.goodsInfo }\n      params.images = JSON.stringify(images)\n      params.details = JSON.stringify(details)\n      params.exchange = JSON.stringify(params.exchange)\n      if (params.start_date.length === 10) {\n        params.start_date += ' 00:00:00'\n      }\n      if (params.end_date.length === 10) {\n        params.end_date += ' 23:59:59'\n      }\n      params.cut_expire = JSON.stringify(new Array({\n        start_time: params.startTime,\n        end_time: params.endTime\n      }))\n      delete params['startTime']\n      delete params['endTime']\n      let mode = this.isUpdate ? 'change_info' : 'add_info'\n      params.mode = mode\n      params.type = 1\n      this.$http({\n        url: '/travel/goods/options',\n        method: 'POST',\n        data: qs.stringify(params)\n      }).then(response => {\n        let res = response.data\n        if (res.respcd === '0000') {\n          this.$store.dispatch('setAlert', {\n            alert: true,\n            alertContent: this.isUpdate ? '修改商品成功' : '新增商品成功',\n            alertType: 'success'\n          })\n          this.isShowDialog = false\n          this.fetchData()\n        } else {\n          this.$store.dispatch('setAlert', {\n            alert: true,\n            alertContent: res.respmsg,\n            alertType: 'error'\n          })\n        }\n      })\n    },\n    beforeUpdateStatus (value, id) {\n      let status = value === 1 ? 0 : 1\n      this.showComfirm = true\n      this.currentItem = {\n        status,\n        id\n      }\n    },\n    cancelUpdateStatus () {\n      this.showComfirm = false\n      this.desserts.map((item) => {\n        if (item.id === this.currentItem.id) {\n          item.status = this.currentItem.status\n        }\n      })\n    },\n    updateStatus () {\n      let status = this.currentItem.status === 1 ? 0 : 1\n      this.$http({\n        url: '/travel/goods/options',\n        method: 'POST',\n        data: qs.stringify({\n          id: this.currentItem.id,\n          mode: 'change_info',\n          status\n        })\n      }).then(response => {\n        let res = response.data\n        if (res.respcd === '0000') {\n          this.showComfirm = false\n          this.$store.dispatch('setAlert', {\n            alert: true,\n            alertContent: status === 1 ? '上架商品成功' : '下架商品成功',\n            alertType: 'success',\n            alertColor: status === 1 ? 'primary' : 'rgba(0,0,0,.38)'\n          })\n        }\n      })\n    },\n    reset () {\n      this.$refs.form.reset()\n      this.useridErrorMessages = ''\n      this.currencyErrorMessages = ''\n      this.$refs.uploadimage.previewImages = []\n      this.$refs.uploadetail.previewImages = []\n    }\n  }\n}\n",{"version":3,"sources":["Goods.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA6HA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"Goods.vue","sourceRoot":"src/pages/welfare/views","sourcesContent":["<template>\n  <div class=\"goods\">\n    <v-layout align-center justify-end style=\"height:64px\">\n      <v-btn @click=\"addButton()\" color=\"primary\" dark>新增商品</v-btn>\n    </v-layout>\n    <v-data-table\n      :headers=\"headers\"\n      :items=\"desserts\"\n      :loading=\"isPending\"\n      hide-actions\n      class=\"elevation-1\"\n    >\n      <template slot=\"items\" slot-scope=\"props\">\n        <td>{{ props.item.id }}</td>\n        <td>{{ props.item.name }}</td>\n        <td>￥{{ props.item.original | formatCurrency }}</td>\n        <td>￥{{ props.item.current | formatCurrency }}</td>\n        <td>{{ props.item.bought }}/{{ props.item.total }}</td>\n        <td>{{ props.item.mchnt }} ({{ props.item.userid }})</td>\n        <td>{{ props.item.area | formatArea }}</td>\n        <td>\n          <v-switch @change=\"beforeUpdateStatus($event, props.item.id)\" v-model=\"props.item.status\" color=\"primary\" :messages=\"props.item.status === 1 ? '已上架' : '已下架'\"  :true-value=\"1\" :false-value=\"0\"></v-switch>\n        </td>\n        <td>\n          <v-btn flat icon color=\"primary\" class=\"mx-0\" @click=\"viewGoods(props.item)\">\n            <v-icon small>details</v-icon>\n          </v-btn>\n        </td>\n      </template>\n      <template slot=\"no-data\">\n        <p style=\"text-align:center;padding-top:16px;\">暂无数据</p>\n      </template>\n    </v-data-table>\n    <div class=\"pagination-container\">\n      <span class=\"pagination-total\">共 {{total}} 条</span>\n      <v-select\n        v-model=\"pageSize\"\n        :items=\"selectItems\"\n        @change=\"fetchData()\"\n        height=\"20\"\n        label=\"10页/条\"\n        solo\n      ></v-select>\n      <v-pagination\n        v-model=\"page\"\n        @input=\"fetchData()\"\n        :length=\"parseInt(total / pageSize) + 1\"\n        :total-visible=\"7\"\n      ></v-pagination>\n    </div>\n\n    <v-dialog\n      v-model=\"isShowDialog\"\n      fullscreen\n      hide-overlay\n      transition=\"dialog-bottom-transition\"\n    >\n      <v-toolbar card dark color=\"primary\">\n        <v-toolbar-title v-if=\"isReadOnly\">商品详情</v-toolbar-title>\n        <v-toolbar-title v-else>{{isUpdate ? '修改商品' : '新增商品'}}</v-toolbar-title>\n        <v-spacer></v-spacer>\n        <v-btn icon dark @click.native=\"isShowDialog = false\">\n          <v-icon>close</v-icon>\n        </v-btn>\n      </v-toolbar>\n      <v-form ref=\"form\" v-model=\"valid\" lazy-validation>\n        <v-text-field label=\"名称\" :readonly=\"isReadOnly\" :rules=\"formRulse.nameRules\" counter=\"100\" v-model=\"goodsInfo.name\"/>\n        <uploadImage label=\"图片\" :readonly=\"isReadOnly\" ref=\"uploadimage\" :maxNumber=\"9\"/>\n        <p class=\"pt-2\" style=\"color:rgba(0,0,0,.54)\">* jpg格式，最多9张，不超过200k, 推荐尺寸254*192</p>\n        <v-textarea label=\"描述\" counter=\"1000\" :readonly=\"isReadOnly\" :rules=\"formRulse.introRules\" auto-grow v-model=\"goodsInfo.intro\"/>\n        <uploadImage label=\"详细图\" :readonly=\"isReadOnly\" ref=\"uploadetail\" :maxNumber=\"9\"/>\n        <p class=\"pt-2\" style=\"color:rgba(0,0,0,.54)\">* jpg格式，最多9张，不超过300k, 推荐尺寸宽400~600，高不限</p>\n        <v-text-field label=\"原价\" ref=\"original\" :readonly=\"isReadOnly\" :rules=\"formRulse.originalRules\" v-model=\"original_format\" @input=\"verifyCurrency()\" :error-messages=\"currencyErrorMessages\"/>\n        <v-text-field label=\"现价\" ref=\"current\" :readonly=\"isReadOnly\" :rules=\"formRulse.currentRules\" v-model=\"current_format\" @input=\"verifyCurrency()\" :error-messages=\"currencyErrorMessages\"/>\n        <v-text-field label=\"库存\" :readonly=\"isReadOnly\" :rules=\"formRulse.totalRules\" v-model=\"goodsInfo.total\"/>\n        <label class=\"custom-label\">有效期</label>\n        <v-layout align-center justify-space-between>\n          <v-menu v-model=\"startDatemenu\" :disabled=\"isReadOnly\" transition=\"scale-transition\" :close-on-content-click=\"false\" style=\"width:260px\">\n            <v-text-field append-icon=\"event\" :rules=\"formRulse.dateRules\" slot=\"activator\" readonly label=\"开始日期\" v-model=\"goodsInfo.start_date\"></v-text-field>\n            <v-date-picker color=\"primary\" v-model=\"goodsInfo.start_date\" :max=\"goodsInfo.end_date\" locale=\"zh-Hans\" no-title @input=\"startDatemenu = false\"></v-date-picker>\n          </v-menu>\n          <v-menu v-model=\"endDatemenu\" :disabled=\"isReadOnly\" transition=\"scale-transition\" :close-on-content-click=\"false\" style=\"width:260px\">\n            <v-text-field append-icon=\"event\" :rules=\"formRulse.dateRules\" slot=\"activator\" readonly label=\"结束日期\" v-model=\"goodsInfo.end_date\"></v-text-field>\n            <v-date-picker color=\"primary\" v-model=\"goodsInfo.end_date\" :min=\"goodsInfo.start_date\" locale=\"zh-Hans\" no-title @input=\"endDatemenu = false\"></v-date-picker>\n          </v-menu>\n        </v-layout>\n        <label class=\"custom-label\">使用时间段</label>\n        <v-layout align-center justify-space-between>\n          <v-menu ref=\"startmenu\" v-model=\"startTimeMenu\" :disabled=\"isReadOnly\" :close-on-content-click=\"false\" transition=\"scale-transition\" style=\"width:260px\">\n            <v-text-field label=\"开始时间\" ref=\"startime\" append-icon=\"event\" slot=\"activator\" readonly v-model=\"goodsInfo.startTime\"></v-text-field>\n            <v-time-picker v-if=\"startTimeMenu\" v-model=\"goodsInfo.startTime\" :max=\"goodsInfo.endTime\" format=\"24hr\" no-title @change=\"$refs.startmenu.save(goodsInfo.startTime)\"></v-time-picker>\n          </v-menu>\n          <v-menu ref=\"endmenu\" v-model=\"endTimeMenu\" :disabled=\"isReadOnly\" :close-on-content-click=\"false\" transition=\"scale-transition\" style=\"width:260px\">\n            <v-text-field label=\"结束时间\" ref=\"endtime\" append-icon=\"event\" slot=\"activator\" readonly v-model=\"goodsInfo.endTime\"></v-text-field>\n            <v-time-picker v-if=\"endTimeMenu\" v-model=\"goodsInfo.endTime\" :min=\"goodsInfo.startTime\" format=\"24hr\" no-title @change=\"$refs.endmenu.save(goodsInfo.endTime)\"></v-time-picker>\n          </v-menu>\n        </v-layout>\n        <v-textarea label=\"注意事项\" :readonly=\"isReadOnly\" counter=\"400\" :rules=\"formRulse.noticeRules\" auto-grow v-model=\"goodsInfo.notice\"></v-textarea>\n        <v-text-field label=\"商品来源\" :readonly=\"isReadOnly\" :counter=\"goodsInfo.src ? 10 : undefined\" :rules=\"formRulse.srcRules\" v-model=\"goodsInfo.src\"/>\n        <v-text-field label=\"关联商户id\" :readonly=\"isReadOnly\" :rules=\"formRulse.useridRules\" v-model=\"goodsInfo.userid\" :error-messages=\"useridErrorMessages\" @blur=\"fetchStores($event.target.value, true)\"/>\n        <v-select\n          label=\"兑换门店\"\n          :items=\"stores\"\n          item-text=\"name\"\n          item-value=\"id\"\n          :rules=\"formRulse.storesRules\"\n          v-model=\"goodsInfo.exchange\"\n          multiple\n          return-object\n          chips\n        ></v-select>\n        <div v-if=\"isReadOnly\" style=\"text-align:right;\">\n          <v-btn @click=\"isReadOnly = false\" color=\"primary\">编辑</v-btn>\n        </div>\n        <div v-else style=\"text-align:right;\">\n          <v-btn :disabled=\"!valid\" @click=\"submit()\" color=\"primary\">保存</v-btn>\n          <v-btn @click=\"reset()\">重置</v-btn>\n        </div>\n      </v-form>\n    </v-dialog>\n    <comfirm @okHandler=\"updateStatus()\" @cancelHandler=\"cancelUpdateStatus()\" :isVisiable=\"showComfirm\" :msg=\"currentItem.status === 1 ? '确定下架该商品吗？' : '确定上架该商品吗？'\" />\n  </div>\n</template>\n\n<script>\n// @ is an alias to /src\nimport UploadImage from '../components/UploadImage'\nimport Comfirm from '@/components/Comfirm'\nimport qs from 'qs'\nexport default {\n  components: {\n    UploadImage,\n    Comfirm\n  },\n  data () {\n    return {\n      headers: [\n        { text: '商品ID', value: 'id', sortable: false },\n        { text: '商品名称', value: 'name', sortable: false },\n        { text: '原价', value: 'original', sortable: false },\n        { text: '现价', value: 'current', sortable: false },\n        { text: '库存', value: 'total', sortable: false },\n        { text: '商户', value: 'id', sortable: false },\n        { text: '地区', value: 'address', sortable: false },\n        { text: '状态', value: 'status', sortable: false },\n        { text: '详情', value: 'id', sortable: false }\n      ],\n      isPending: false,\n      desserts: [],\n      total: 0,\n      page: 1,\n      pageSize: 10,\n      currentItem: {}, // 当前操作 table item\n      showComfirm: false,\n      selectItems: [{\n        value: 10,\n        text: '10条/页'\n      }, {\n        value: 20,\n        text: '20条/页'\n      }, {\n        value: 50,\n        text: '50条/页'\n      }],\n      isShowDialog: false, // 新增弹框\n      isReadOnly: false,\n      isUpdate: false,\n      valid: false,\n      startDatemenu: false,\n      endDatemenu: false,\n      startTimeMenu: false,\n      endTimeMenu: false,\n      goodsInfo: {\n        name: '',\n        images: [],\n        intro: '',\n        details: [],\n        notice: '',\n        start_date: '',\n        end_date: '',\n        startTime: null,\n        endTime: null,\n        exchange: [],\n        userid: ''\n      },\n      stores: [], // 适用门店\n      formRulse: {\n        nameRules: [\n          v => !!v || '商品名称不能为空',\n          v => (v && v.length <= 100) || '100字以内'\n        ],\n        introRules: [\n          v => (v && v.length <= 1000) || '1000字以内'\n        ],\n        originalRules: [\n          v => !!v || '原价不能为空',\n          v => /^\\d+(\\.\\d{1,2})?$/.test(v) || '原价格式不正确'\n        ],\n        currentRules: [\n          v => !!v || '现价不能为空',\n          v => /^\\d+(\\.\\d{1,2})?$/.test(v) || '现价格式不正确'\n        ],\n        totalRules: [\n          v => !!v || '库存不能为空',\n          v => /^[1-9]\\d*$/.test(v) || '库存必须为数值'\n        ],\n        dateRules: [\n          v => !!v || '有效期不能为空'\n        ],\n        useridRules: [\n          v => !!v || '关联商户id不能为空'\n        ],\n        srcRules: [\n          v => (!v || v.length <= 10) || '10字以内'\n        ],\n        storesRules: [\n          v => (Array.isArray(v) && v.length > 0) || '兑换门店不能为空'\n        ],\n        noticeRules: [\n          v => (v && v.length <= 400) || '400字以内'\n        ]\n      },\n      currencyErrorMessages: '',\n      useridErrorMessages: ''\n    }\n  },\n  computed: {\n    current_format: {\n      get: function () {\n        return this.goodsInfo.current / 100 || ''\n      },\n      set: function (value) {\n        this.goodsInfo.current = value * 100 || ''\n      }\n    },\n    original_format: {\n      get: function () {\n        return this.goodsInfo.original / 100 || ''\n      },\n      set: function (value) {\n        this.goodsInfo.original = value * 100 || ''\n      }\n    }\n  },\n  created () {\n    this.fetchData()\n  },\n  methods: {\n    verifyCurrency() {\n      if (!this.goodsInfo.current || !this.goodsInfo.original) {\n        return\n      }\n      if (this.goodsInfo.original < this.goodsInfo.current) {\n        this.currencyErrorMessages = '原价不能小于现价'\n      } else {\n        this.currencyErrorMessages = ''\n      }\n    },\n    fetchData () {\n      this.isPending = true\n      this.$http({\n        url: '/travel/goods/info',\n        method: 'GET',\n        params: {\n          type: 1,\n          pageSize: this.pageSize,\n          page: this.page - 1 // 接口 第一页 page = 0\n        }\n      }).then(response => {\n        this.isPending = false\n        let res = response.data\n        if (res.respcd === '0000') {\n          this.desserts = res.data.list\n          this.total = res.data.total\n        } else {\n          this.$store.dispatch('setAlert', {\n            alert: true,\n            alertContent: res.respmsg,\n            alertType: 'error'\n          })\n        }\n      })\n    },\n    fetchStores (id, resetSelected) {\n      if (resetSelected && Number(id) === this.goodsInfo.userid) {\n        return\n      }\n      this.$http({\n        url: '/travel/goods/options',\n        method: 'POST',\n        data: qs.stringify({\n          id,\n          mode: 'shop_info'\n        })\n      }).then(response => {\n        let res = response.data\n        if (res.respcd === '0000') {\n          this.useridErrorMessages = ''\n          if (resetSelected) {\n            this.stores = []\n            this.goodsInfo.exchange = []\n          }\n          res.data.map((item) => {\n            this.stores.push({\n              id: item.id,\n              name: item.name\n            })\n          })\n        } else if (res.respcd === '2102') {\n          this.useridErrorMessages = '该商户不存在，请检查商户id是否正确'\n        } else if (res.respcd === '2101') {\n          this.useridErrorMessages = '该商户下没有门店，请先添加门店'\n        }\n      })\n    },\n    addButton () {\n      this.reset()\n      this.isReadOnly = false\n      this.isShowDialog = true\n      this.isUpdate = false\n    },\n    goGoodsDetail (id, name) {\n      window.sessionStorage.setItem('goodsName', name)\n      this.$router.push({\n        name: 'store',\n        params: {\n          goodsId: id\n        }\n      })\n    },\n    viewGoods (info) {\n      this.isReadOnly = true\n      this.isShowDialog = true\n      this.isUpdate = true\n      this.goodsInfo = { ...info }\n      this.goodsInfo.start_date = info.start_date.substr(0, 10)\n      this.goodsInfo.end_date = info.end_date.substr(0, 10)\n      if (info.cut_expire) {\n        this.goodsInfo.startTime = info.cut_expire[0].start_time\n        this.goodsInfo.endTime = info.cut_expire[0].end_time\n      }\n      delete this.goodsInfo['cut_expire']\n      this.$refs.uploadimage.previewImages = [...info.images]\n      this.$refs.uploadetail.previewImages = [...info.details]\n      this.fetchStores(info.userid, false)\n    },\n    submit () {\n      if (!this.$refs.form.validate()) {\n        return\n      }\n      let images = this.$refs.uploadimage.previewImages\n      let details = this.$refs.uploadetail.previewImages\n      if (images.length === 0) {\n        this.$store.dispatch('setAlert', {\n          alert: true,\n          alertContent: '请上传商品图片',\n          alertType: 'warning'\n        })\n        return false\n      }\n      if (details.length === 0) {\n        this.$store.dispatch('setAlert', {\n          alert: true,\n          alertContent: '请上传商品详情图',\n          alertType: 'warning'\n        })\n        return false\n      }\n      let startTime = this.goodsInfo.startTime\n      let endTime = this.goodsInfo.endTime\n      if ((!!startTime && !endTime) || (!startTime && !!endTime)) {\n        this.$store.dispatch('setAlert', {\n          alert: true,\n          alertContent: '请填写完整使用时间段',\n          alertType: 'warning'\n        })\n        return false\n      }\n      let params = { ...this.goodsInfo }\n      params.images = JSON.stringify(images)\n      params.details = JSON.stringify(details)\n      params.exchange = JSON.stringify(params.exchange)\n      if (params.start_date.length === 10) {\n        params.start_date += ' 00:00:00'\n      }\n      if (params.end_date.length === 10) {\n        params.end_date += ' 23:59:59'\n      }\n      params.cut_expire = JSON.stringify(new Array({\n        start_time: params.startTime,\n        end_time: params.endTime\n      }))\n      delete params['startTime']\n      delete params['endTime']\n      let mode = this.isUpdate ? 'change_info' : 'add_info'\n      params.mode = mode\n      params.type = 1\n      this.$http({\n        url: '/travel/goods/options',\n        method: 'POST',\n        data: qs.stringify(params)\n      }).then(response => {\n        let res = response.data\n        if (res.respcd === '0000') {\n          this.$store.dispatch('setAlert', {\n            alert: true,\n            alertContent: this.isUpdate ? '修改商品成功' : '新增商品成功',\n            alertType: 'success'\n          })\n          this.isShowDialog = false\n          this.fetchData()\n        } else {\n          this.$store.dispatch('setAlert', {\n            alert: true,\n            alertContent: res.respmsg,\n            alertType: 'error'\n          })\n        }\n      })\n    },\n    beforeUpdateStatus (value, id) {\n      let status = value === 1 ? 0 : 1\n      this.showComfirm = true\n      this.currentItem = {\n        status,\n        id\n      }\n    },\n    cancelUpdateStatus () {\n      this.showComfirm = false\n      this.desserts.map((item) => {\n        if (item.id === this.currentItem.id) {\n          item.status = this.currentItem.status\n        }\n      })\n    },\n    updateStatus () {\n      let status = this.currentItem.status === 1 ? 0 : 1\n      this.$http({\n        url: '/travel/goods/options',\n        method: 'POST',\n        data: qs.stringify({\n          id: this.currentItem.id,\n          mode: 'change_info',\n          status\n        })\n      }).then(response => {\n        let res = response.data\n        if (res.respcd === '0000') {\n          this.showComfirm = false\n          this.$store.dispatch('setAlert', {\n            alert: true,\n            alertContent: status === 1 ? '上架商品成功' : '下架商品成功',\n            alertType: 'success',\n            alertColor: status === 1 ? 'primary' : 'rgba(0,0,0,.38)'\n          })\n        }\n      })\n    },\n    reset () {\n      this.$refs.form.reset()\n      this.useridErrorMessages = ''\n      this.currencyErrorMessages = ''\n      this.$refs.uploadimage.previewImages = []\n      this.$refs.uploadetail.previewImages = []\n    }\n  }\n}\n</script>\n"]}]}